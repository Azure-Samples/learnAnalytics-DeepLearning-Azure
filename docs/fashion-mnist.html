<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Deep Learning on Azure</title>
  <meta name="description" content="Rendered version of Deep Learning on Azure materials.">
  <meta name="generator" content="bookdown 0.5 and GitBook 2.6.7">

  <meta property="og:title" content="Deep Learning on Azure" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Rendered version of Deep Learning on Azure materials." />
  <meta name="github-repo" content="Azure/learnAnalytics-DeepLearning-Azure" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Deep Learning on Azure" />
  
  <meta name="twitter:description" content="Rendered version of Deep Learning on Azure materials." />
  

<meta name="author" content="Ali Zaidi">


<meta name="date" content="2017-10-04">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="transfer-learning-with-cntk.html">
<link rel="next" href="neural-style-transfer.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Deep Learning on Azure</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Preface</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#part-i---fundamentals-and-azure-for-machine-learning"><i class="fa fa-check"></i><b>1.1</b> Part I - Fundamentals and Azure for Machine Learning</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#part-ii---optimization"><i class="fa fa-check"></i><b>1.2</b> Part II - Optimization</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#part-iii---convolutional-neural-networks"><i class="fa fa-check"></i><b>1.3</b> Part III - Convolutional Neural Networks</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#part-iv---recurrent-networks"><i class="fa fa-check"></i><b>1.4</b> Part IV - Recurrent Networks</a></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#part-v---reinforcement-learning"><i class="fa fa-check"></i><b>1.5</b> Part V - Reinforcement Learning</a></li>
<li class="chapter" data-level="1.6" data-path="index.html"><a href="index.html#part-vi---generative-models"><i class="fa fa-check"></i><b>1.6</b> Part VI - Generative Models</a></li>
<li class="chapter" data-level="1.7" data-path="index.html"><a href="index.html#part-vii---operationalization-methods"><i class="fa fa-check"></i><b>1.7</b> Part VII - Operationalization Methods</a></li>
<li class="chapter" data-level="1.8" data-path="index.html"><a href="index.html#useful-resources"><i class="fa fa-check"></i><b>1.8</b> Useful Resources</a><ul>
<li class="chapter" data-level="1.8.1" data-path="index.html"><a href="index.html#online-courses"><i class="fa fa-check"></i><b>1.8.1</b> Online Courses</a></li>
<li class="chapter" data-level="1.8.2" data-path="index.html"><a href="index.html#online-books-and-blogs"><i class="fa fa-check"></i><b>1.8.2</b> Online Books and Blogs</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="provisioning-linux-dsvms-with-azure-cli-2-0.html"><a href="provisioning-linux-dsvms-with-azure-cli-2-0.html"><i class="fa fa-check"></i><b>2</b> Provisioning Linux DSVMs with Azure CLI 2.0</a><ul>
<li class="chapter" data-level="2.1" data-path="provisioning-linux-dsvms-with-azure-cli-2-0.html"><a href="provisioning-linux-dsvms-with-azure-cli-2-0.html#installing-and-testing-the-azure-cli"><i class="fa fa-check"></i><b>2.1</b> Installing and Testing the Azure CLI</a></li>
<li class="chapter" data-level="2.2" data-path="provisioning-linux-dsvms-with-azure-cli-2-0.html"><a href="provisioning-linux-dsvms-with-azure-cli-2-0.html#login-to-your-azure-account"><i class="fa fa-check"></i><b>2.2</b> Login to Your Azure Account</a></li>
<li class="chapter" data-level="2.3" data-path="provisioning-linux-dsvms-with-azure-cli-2-0.html"><a href="provisioning-linux-dsvms-with-azure-cli-2-0.html#deploying-via-custom-script"><i class="fa fa-check"></i><b>2.3</b> <a name="deploying"></a> Deploying Via Custom Script</a></li>
<li class="chapter" data-level="2.4" data-path="provisioning-linux-dsvms-with-azure-cli-2-0.html"><a href="provisioning-linux-dsvms-with-azure-cli-2-0.html#updating-dsvm-os-disk-size"><i class="fa fa-check"></i><b>2.4</b> Updating DSVM OS Disk Size</a></li>
<li class="chapter" data-level="2.5" data-path="provisioning-linux-dsvms-with-azure-cli-2-0.html"><a href="provisioning-linux-dsvms-with-azure-cli-2-0.html#deploying-manually-only-proceed-if-you-didnt-use-the-script-above"><i class="fa fa-check"></i><b>2.5</b> Deploying Manually <strong>(Only Proceed if You Didnâ€™t Use the Script Above!)</strong></a><ul>
<li class="chapter" data-level="2.5.1" data-path="provisioning-linux-dsvms-with-azure-cli-2-0.html"><a href="provisioning-linux-dsvms-with-azure-cli-2-0.html#create-a-new-resource-group"><i class="fa fa-check"></i><b>2.5.1</b> Create a New Resource Group</a></li>
<li class="chapter" data-level="2.5.2" data-path="provisioning-linux-dsvms-with-azure-cli-2-0.html"><a href="provisioning-linux-dsvms-with-azure-cli-2-0.html#create-your-dsvm"><i class="fa fa-check"></i><b>2.5.2</b> Create Your DSVM</a></li>
<li class="chapter" data-level="2.5.3" data-path="provisioning-linux-dsvms-with-azure-cli-2-0.html"><a href="provisioning-linux-dsvms-with-azure-cli-2-0.html#create-a-password-for-the-user"><i class="fa fa-check"></i><b>2.5.3</b> Create a Password for the User</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="upgrading-cntk-and-cudnn.html"><a href="upgrading-cntk-and-cudnn.html"><i class="fa fa-check"></i><b>3</b> Upgrading CNTK and CUDNN</a><ul>
<li class="chapter" data-level="3.1" data-path="upgrading-cntk-and-cudnn.html"><a href="upgrading-cntk-and-cudnn.html#updating-cntk"><i class="fa fa-check"></i><b>3.1</b> Updating CNTK</a></li>
<li class="chapter" data-level="3.2" data-path="upgrading-cntk-and-cudnn.html"><a href="upgrading-cntk-and-cudnn.html#updating-cntk-with-a-single-script"><i class="fa fa-check"></i><b>3.2</b> Updating CNTK With a Single Script</a><ul>
<li class="chapter" data-level="3.2.1" data-path="upgrading-cntk-and-cudnn.html"><a href="upgrading-cntk-and-cudnn.html#launch-jupyterlab"><i class="fa fa-check"></i><b>3.2.1</b> Launch JupyterLab</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="upgrading-cntk-and-cudnn.html"><a href="upgrading-cntk-and-cudnn.html#manually-updating-cntk-and-launching-jupyter-no-need-to-do-this-if-you-use-the-script"><i class="fa fa-check"></i><b>3.3</b> Manually Updating CNTK and Launching Jupyter (<strong>No Need to Do This if You Use the Script</strong>)</a><ul>
<li class="chapter" data-level="3.3.1" data-path="upgrading-cntk-and-cudnn.html"><a href="upgrading-cntk-and-cudnn.html#create-conda-virtual-environment"><i class="fa fa-check"></i><b>3.3.1</b> Create Conda Virtual Environment</a></li>
<li class="chapter" data-level="3.3.2" data-path="upgrading-cntk-and-cudnn.html"><a href="upgrading-cntk-and-cudnn.html#install-cntk-using-pip-binary-wheels"><i class="fa fa-check"></i><b>3.3.2</b> Install CNTK Using <code>pip</code> Binary Wheels</a></li>
<li class="chapter" data-level="3.3.3" data-path="upgrading-cntk-and-cudnn.html"><a href="upgrading-cntk-and-cudnn.html#temporary-fixes"><i class="fa fa-check"></i><b>3.3.3</b> Temporary Fixes</a></li>
<li class="chapter" data-level="3.3.4" data-path="upgrading-cntk-and-cudnn.html"><a href="upgrading-cntk-and-cudnn.html#conda-extensions"><i class="fa fa-check"></i><b>3.3.4</b> Conda Extensions</a></li>
<li class="chapter" data-level="3.3.5" data-path="upgrading-cntk-and-cudnn.html"><a href="upgrading-cntk-and-cudnn.html#install-keras"><i class="fa fa-check"></i><b>3.3.5</b> Install Keras</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="transfer-learning-with-cntk.html"><a href="transfer-learning-with-cntk.html"><i class="fa fa-check"></i><b>4</b> Transfer Learning with CNTK</a><ul>
<li class="chapter" data-level="4.1" data-path="transfer-learning-with-cntk.html"><a href="transfer-learning-with-cntk.html#classifying-dogs-and-cats-using-a-pre-trained-network"><i class="fa fa-check"></i><b>4.1</b> Classifying Dogs and Cats Using a Pre-Trained Network</a><ul>
<li class="chapter" data-level="4.1.1" data-path="transfer-learning-with-cntk.html"><a href="transfer-learning-with-cntk.html#download-data"><i class="fa fa-check"></i><b>4.1.1</b> Download Data</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="transfer-learning-with-cntk.html"><a href="transfer-learning-with-cntk.html#create-train-test-and-validate-sets"><i class="fa fa-check"></i><b>4.2</b> Create Train, Test and Validate Sets</a></li>
<li class="chapter" data-level="4.3" data-path="transfer-learning-with-cntk.html"><a href="transfer-learning-with-cntk.html#kittypupsploration"><i class="fa fa-check"></i><b>4.3</b> Kittypupsploration</a></li>
<li class="chapter" data-level="4.4" data-path="transfer-learning-with-cntk.html"><a href="transfer-learning-with-cntk.html#data-readers-in-cntk"><i class="fa fa-check"></i><b>4.4</b> Data Readers in CNTK</a></li>
<li class="chapter" data-level="4.5" data-path="transfer-learning-with-cntk.html"><a href="transfer-learning-with-cntk.html#pre-trained-models"><i class="fa fa-check"></i><b>4.5</b> Pre-Trained Models</a></li>
<li class="chapter" data-level="4.6" data-path="transfer-learning-with-cntk.html"><a href="transfer-learning-with-cntk.html#defining-model-architecture"><i class="fa fa-check"></i><b>4.6</b> Defining Model Architecture</a></li>
<li class="chapter" data-level="4.7" data-path="transfer-learning-with-cntk.html"><a href="transfer-learning-with-cntk.html#training-the-transfer-model"><i class="fa fa-check"></i><b>4.7</b> Training the Transfer Model</a></li>
<li class="chapter" data-level="4.8" data-path="transfer-learning-with-cntk.html"><a href="transfer-learning-with-cntk.html#define-minibatch-source"><i class="fa fa-check"></i><b>4.8</b> Define Minibatch Source</a></li>
<li class="chapter" data-level="4.9" data-path="transfer-learning-with-cntk.html"><a href="transfer-learning-with-cntk.html#training"><i class="fa fa-check"></i><b>4.9</b> Training</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="fashion-mnist.html"><a href="fashion-mnist.html"><i class="fa fa-check"></i><b>5</b> Fashion MNIST</a><ul>
<li class="chapter" data-level="5.1" data-path="fashion-mnist.html"><a href="fashion-mnist.html#import-core-libraries-and-specify-keras-backend"><i class="fa fa-check"></i><b>5.1</b> Import Core Libraries and Specify Keras Backend</a></li>
<li class="chapter" data-level="5.2" data-path="fashion-mnist.html"><a href="fashion-mnist.html#downloading-fashion-dataset"><i class="fa fa-check"></i><b>5.2</b> Downloading Fashion Dataset</a></li>
<li class="chapter" data-level="5.3" data-path="fashion-mnist.html"><a href="fashion-mnist.html#scale-data-and-visualize"><i class="fa fa-check"></i><b>5.3</b> Scale Data and Visualize</a></li>
<li class="chapter" data-level="5.4" data-path="fashion-mnist.html"><a href="fashion-mnist.html#create-network-architecture-and-model-parameters"><i class="fa fa-check"></i><b>5.4</b> Create Network Architecture and Model Parameters</a></li>
<li class="chapter" data-level="5.5" data-path="fashion-mnist.html"><a href="fashion-mnist.html#training-our-model"><i class="fa fa-check"></i><b>5.5</b> Training Our Model</a></li>
<li class="chapter" data-level="5.6" data-path="fashion-mnist.html"><a href="fashion-mnist.html#scoring-the-model"><i class="fa fa-check"></i><b>5.6</b> Scoring the Model</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="neural-style-transfer.html"><a href="neural-style-transfer.html"><i class="fa fa-check"></i><b>6</b> Neural Style Transfer</a><ul>
<li class="chapter" data-level="6.0.1" data-path="neural-style-transfer.html"><a href="neural-style-transfer.html#defining-the-loss-function"><i class="fa fa-check"></i><b>6.0.1</b> Defining the loss function</a></li>
<li class="chapter" data-level="6.0.2" data-path="neural-style-transfer.html"><a href="neural-style-transfer.html#instantiating-the-loss"><i class="fa fa-check"></i><b>6.0.2</b> Instantiating the loss</a></li>
<li class="chapter" data-level="6.0.3" data-path="neural-style-transfer.html"><a href="neural-style-transfer.html#optimizing-the-loss"><i class="fa fa-check"></i><b>6.0.3</b> Optimizing the loss</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://aka.ms/az-dl" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Deep Learning on Azure</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="fashion-mnist" class="section level1">
<h1><span class="header-section-number">Chapter 5</span> Fashion MNIST</h1>
<p>A MNIST-like dataset for fashion items. See the <a href="https://github.com/zalandoresearch/fashion-mnist">original repository</a> for more information and visualization examples.</p>
<div id="import-core-libraries-and-specify-keras-backend" class="section level2">
<h2><span class="header-section-number">5.1</span> Import Core Libraries and Specify Keras Backend</h2>
<p>First, weâ€™ll import some core libraries and some helper functions. Also note that we are updating the <code>KERAS_BACKEND</code> variable to point to <code>CNTK</code> rather than <code>TensorFlow</code> or <code>Theano</code>. This is a convenient way of doing this interactively in a single session. If youâ€™d like to make this your default, modify the <code>~/.keras/keras.json</code> file to always point to CNTK.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> os
os.environ[<span class="st">&#39;KERAS_BACKEND&#39;</span>] <span class="op">=</span> <span class="st">&quot;cntk&quot;</span>

<span class="im">import</span> sys
<span class="im">import</span> urllib

<span class="im">from</span> keras.layers <span class="im">import</span> Dense, Dropout, Flatten
<span class="im">from</span> keras.layers <span class="im">import</span> Conv2D, MaxPooling2D
<span class="im">from</span> keras.layers.normalization <span class="im">import</span> BatchNormalization

<span class="im">from</span> keras.models <span class="im">import</span> Sequential
<span class="im">from</span> keras.utils <span class="im">import</span> to_categorical

<span class="im">from</span> keras.callbacks <span class="im">import</span> ModelCheckpoint, TensorBoard
<span class="im">from</span> keras <span class="im">import</span> optimizers
<span class="im">from</span> keras <span class="im">import</span> losses

<span class="im">from</span> fashion_import <span class="im">import</span> load_data

<span class="im">import</span> numpy <span class="im">as</span> np
<span class="im">from</span> PIL <span class="im">import</span> Image
<span class="im">from</span> io <span class="im">import</span> BytesIO</code></pre></div>
<pre><code>Using CNTK backend</code></pre>
</div>
<div id="downloading-fashion-dataset" class="section level2">
<h2><span class="header-section-number">5.2</span> Downloading Fashion Dataset</h2>
<p>The Fashion dataset is not yet preloaded into Keras. We have a simple helper function called <code>load_data</code> which will load the data into memory for us.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">(x_train, y_train), (x_test, y_test) <span class="op">=</span> load_data()</code></pre></div>
<pre><code>Downloading data from http://fashion-mnist.s3-website.eu-central-1.amazonaws.com/train-labels-idx1-ubyte.gz
16384/29515 [===============&gt;..............] - ETA: 0sDownloading data from http://fashion-mnist.s3-website.eu-central-1.amazonaws.com/train-images-idx3-ubyte.gz
23953408/26421880 [==========================&gt;...] - ETA: 0sDownloading data from http://fashion-mnist.s3-website.eu-central-1.amazonaws.com/t10k-labels-idx1-ubyte.gz
8192/5148 [===============================================] - 0s
Downloading data from http://fashion-mnist.s3-website.eu-central-1.amazonaws.com/t10k-images-idx3-ubyte.gz
3260416/4422102 [=====================&gt;........] - ETA: 0s</code></pre>
</div>
<div id="scale-data-and-visualize" class="section level2">
<h2><span class="header-section-number">5.3</span> Scale Data and Visualize</h2>
<p>Now that we have our data ingested into memory, letâ€™s scale it into unit range and visualize a few examples.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">x_train <span class="op">=</span> x_train.reshape(<span class="dv">60000</span>, <span class="dv">28</span>, <span class="dv">28</span>, <span class="dv">1</span>)
x_test <span class="op">=</span> x_test.reshape(<span class="dv">10000</span>, <span class="dv">28</span>, <span class="dv">28</span>, <span class="dv">1</span>)
x_train <span class="op">=</span> x_train.astype(<span class="st">&#39;float32&#39;</span>)
x_test <span class="op">=</span> x_test.astype(<span class="st">&#39;float32&#39;</span>)
x_train <span class="op">/=</span> <span class="dv">255</span>
x_test <span class="op">/=</span> <span class="dv">255</span>

<span class="co"># convert class vectors to binary class matrices</span>
y_train <span class="op">=</span> to_categorical(y_train, <span class="dv">10</span>)
y_test <span class="op">=</span> to_categorical(y_test, <span class="dv">10</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt
<span class="op">%</span>matplotlib inline
pixels <span class="op">=</span> x_train[<span class="dv">10</span>].reshape((<span class="dv">28</span>, <span class="dv">28</span>))
plt.imshow(pixels)
plt.show()</code></pre></div>
<div class="figure">
<img src="output_5_0.png" alt="png" />
<p class="caption">png</p>
</div>
</div>
<div id="create-network-architecture-and-model-parameters" class="section level2">
<h2><span class="header-section-number">5.4</span> Create Network Architecture and Model Parameters</h2>
<p>Keras has a very simple high-level sequential and functional API for defining network architectures. Here weâ€™ll use the sequential API and compile our model with a common optimization algorithm and loss metrics.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">batch_size <span class="op">=</span> <span class="dv">256</span>
num_classes <span class="op">=</span> <span class="dv">10</span>
epochs <span class="op">=</span> <span class="dv">10</span>

img_rows, img_cols <span class="op">=</span> <span class="dv">28</span>, <span class="dv">28</span>
input_shape <span class="op">=</span> (img_rows, img_cols, <span class="dv">1</span>)

model <span class="op">=</span> Sequential()
model.add(Conv2D(<span class="dv">32</span>, kernel_size<span class="op">=</span>(<span class="dv">3</span>, <span class="dv">3</span>),
                 activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>,
                 kernel_initializer<span class="op">=</span><span class="st">&#39;he_normal&#39;</span>,
                 input_shape<span class="op">=</span>input_shape))
model.add(MaxPooling2D((<span class="dv">2</span>, <span class="dv">2</span>)))
model.add(Dropout(<span class="fl">0.25</span>))
model.add(Conv2D(<span class="dv">64</span>, (<span class="dv">3</span>, <span class="dv">3</span>), activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>))
model.add(MaxPooling2D(pool_size<span class="op">=</span>(<span class="dv">2</span>, <span class="dv">2</span>)))
model.add(Dropout(<span class="fl">0.25</span>))
model.add(Conv2D(<span class="dv">128</span>, (<span class="dv">3</span>, <span class="dv">3</span>), activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>))
model.add(Dropout(<span class="fl">0.4</span>))
model.add(Flatten())
model.add(Dense(<span class="dv">128</span>, activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>))
model.add(Dropout(<span class="fl">0.3</span>))
model.add(Dense(num_classes, activation<span class="op">=</span><span class="st">&#39;softmax&#39;</span>))

model.<span class="bu">compile</span>(loss<span class="op">=</span>losses.categorical_crossentropy,
              optimizer<span class="op">=</span>optimizers.Adam(),
              metrics<span class="op">=</span>[<span class="st">&#39;accuracy&#39;</span>])

model.summary()</code></pre></div>
<pre><code>_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
conv2d_1 (Conv2D)            (None, 26, 26, 32)        320       
_________________________________________________________________
max_pooling2d_1 (MaxPooling2 (None, 13, 13, 32)        0         
_________________________________________________________________
dropout_1 (Dropout)          (None, 13, 13, 32)        0         
_________________________________________________________________
conv2d_2 (Conv2D)            (None, 11, 11, 64)        18496     
_________________________________________________________________
max_pooling2d_2 (MaxPooling2 (None, 5, 5, 64)          0         
_________________________________________________________________
dropout_2 (Dropout)          (None, 5, 5, 64)          0         
_________________________________________________________________
conv2d_3 (Conv2D)            (None, 3, 3, 128)         73856     
_________________________________________________________________
dropout_3 (Dropout)          (None, 3, 3, 128)         0         
_________________________________________________________________
flatten_1 (Flatten)          (None, 1152)              0         
_________________________________________________________________
dense_1 (Dense)              (None, 128)               147584    
_________________________________________________________________
dropout_4 (Dropout)          (None, 128)               0         
_________________________________________________________________
dense_2 (Dense)              (None, 10)                1290      
=================================================================
Total params: 241,546
Trainable params: 241,546
Non-trainable params: 0
_________________________________________________________________</code></pre>
</div>
<div id="training-our-model" class="section level2">
<h2><span class="header-section-number">5.5</span> Training Our Model</h2>
<p>Training the model, i.e., backpropagating to fit model parameters to training data, is as simple as using the <code>fit</code> method in Keras.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">history <span class="op">=</span> model.fit(x_train, y_train,
          batch_size<span class="op">=</span>batch_size,
          epochs<span class="op">=</span>epochs)</code></pre></div>
<pre><code>Epoch 1/10


/home/mugen/.conda/envs/cntk-py35/lib/python3.5/site-packages/cntk/core.py:361: UserWarning: your data is of type &quot;float64&quot;, but your input variable (uid &quot;Input170&quot;) expects &quot;&lt;class &#39;numpy.float32&#39;&gt;&quot;. Please convert your data beforehand to speed up training.
  (sample.dtype, var.uid, str(var.dtype)))


60000/60000 [==============================] - 10s - loss: 0.8519 - acc: 0.6817    
Epoch 2/10
60000/60000 [==============================] - 7s - loss: 0.5029 - acc: 0.8138     
Epoch 3/10
60000/60000 [==============================] - 7s - loss: 0.4330 - acc: 0.8406     
Epoch 4/10
60000/60000 [==============================] - 7s - loss: 0.3867 - acc: 0.8575     
Epoch 5/10
60000/60000 [==============================] - 7s - loss: 0.3595 - acc: 0.8675     
Epoch 6/10
60000/60000 [==============================] - 7s - loss: 0.3365 - acc: 0.8777     
Epoch 7/10
60000/60000 [==============================] - 7s - loss: 0.3203 - acc: 0.8822     
Epoch 8/10
60000/60000 [==============================] - 7s - loss: 0.3112 - acc: 0.8868     
Epoch 9/10
60000/60000 [==============================] - 7s - loss: 0.3001 - acc: 0.8896     
Epoch 10/10
60000/60000 [==============================] - 7s - loss: 0.2889 - acc: 0.8936     </code></pre>
</div>
<div id="scoring-the-model" class="section level2">
<h2><span class="header-section-number">5.6</span> Scoring the Model</h2>
<p>Just as simple is scoring it on our test set. We can simply pass the <code>x_test</code> and <code>y_test</code> arrays to the <code>evaluate</code> method and Keras will score the model for us.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">test_val <span class="op">=</span> model.evaluate(x_test, y_test)</code></pre></div>
<pre><code> 1312/10000 [==&gt;...........................] - ETA: 1s

/anaconda/envs/cntk-22/lib/python3.5/site-packages/cntk/core.py:361: UserWarning: your data is of type &quot;float64&quot;, but your input variable (uid &quot;Input170&quot;) expects &quot;&lt;class &#39;numpy.float32&#39;&gt;&quot;. Please convert your data beforehand to speed up training.
  (sample.dtype, var.uid, str(var.dtype)))


 9856/10000 [============================&gt;.] - ETA: 0s</code></pre>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="bu">print</span>(<span class="st">&quot;Model&#39;s Accuracy on Test Set = &quot;</span>
      <span class="op">+</span> <span class="st">&quot;</span><span class="sc">{0:.2f}</span><span class="st">%&quot;</span>.<span class="bu">format</span>(test_val[<span class="dv">1</span>] <span class="op">*</span> <span class="dv">100</span>))</code></pre></div>
<pre><code>Model&#39;s Accuracy on Test Set = 90.14%</code></pre>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt
<span class="op">%</span>matplotlib inline

accuracy <span class="op">=</span> history.history[<span class="st">&#39;acc&#39;</span>]
<span class="co"># val_accuracy = history.history[&#39;val_acc&#39;]</span>
loss <span class="op">=</span> history.history[<span class="st">&#39;loss&#39;</span>]
<span class="co"># val_loss = history.history[&#39;val_loss&#39;]</span>
epochs <span class="op">=</span> <span class="bu">range</span>(<span class="bu">len</span>(accuracy))
plt.plot(epochs, accuracy, <span class="st">&#39;bo&#39;</span>, label<span class="op">=</span><span class="st">&#39;Training accuracy&#39;</span>)
plt.title(<span class="st">&#39;Training accuracy&#39;</span>)
plt.legend()
plt.figure()
plt.plot(epochs, loss, <span class="st">&#39;bo&#39;</span>, label<span class="op">=</span><span class="st">&#39;Training loss&#39;</span>)
plt.title(<span class="st">&#39;Training loss&#39;</span>)
plt.legend()
plt.show()</code></pre></div>
<div class="figure">
<img src="output_10_0.png" alt="png" />
<p class="caption">png</p>
</div>
<div class="figure">
<img src="output_10_1.png" alt="png" />
<p class="caption">png</p>
</div>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">test_im <span class="op">=</span> x_train[<span class="dv">3</span>]
plt.imshow(test_im.reshape(<span class="dv">28</span>,<span class="dv">28</span>), cmap<span class="op">=</span><span class="st">&#39;gray&#39;</span>, interpolation<span class="op">=</span><span class="st">&#39;none&#39;</span>)
plt.show()</code></pre></div>
<div class="figure">
<img src="output_11_0.png" alt="png" />
<p class="caption">png</p>
</div>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">from</span> keras <span class="im">import</span> models
layer_outputs <span class="op">=</span> [layer.output <span class="cf">for</span> layer <span class="kw">in</span> model.layers[:<span class="dv">8</span>]]
activation_model <span class="op">=</span> models.Model(<span class="bu">input</span><span class="op">=</span>model.<span class="bu">input</span>, output<span class="op">=</span>layer_outputs)
activations <span class="op">=</span> activation_model.predict(test_im.reshape(<span class="dv">1</span>,<span class="dv">28</span>,<span class="dv">28</span>,<span class="dv">1</span>))

first_layer_activation <span class="op">=</span> activations[<span class="dv">0</span>]
plt.matshow(first_layer_activation[<span class="dv">0</span>, :, :, <span class="dv">4</span>], cmap<span class="op">=</span><span class="st">&#39;gray&#39;</span>)</code></pre></div>
<pre><code>/anaconda/envs/cntk-22/lib/python3.5/site-packages/ipykernel/__main__.py:3: UserWarning: Update your `Model` call to the Keras 2 API: `Model(outputs=[Composite..., inputs=Input(&#39;con...)`
  app.launch_new_instance()





&lt;matplotlib.image.AxesImage at 0x7f08c0f78278&gt;</code></pre>
<div class="figure">
<img src="output_12_2.png" alt="png" />
<p class="caption">png</p>
</div>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">layer_names <span class="op">=</span> []
<span class="cf">for</span> layer <span class="kw">in</span> model.layers[:<span class="op">-</span><span class="dv">1</span>]:
    <span class="cf">if</span> <span class="bu">isinstance</span>(layer, Conv2D):
        layer_names.append(layer.name)
images_per_row <span class="op">=</span> <span class="dv">16</span>

<span class="cf">for</span> layer_name, layer_activation <span class="kw">in</span> <span class="bu">zip</span>(layer_names, activations):
    n_features <span class="op">=</span> layer_activation.shape[<span class="op">-</span><span class="dv">1</span>]
    size <span class="op">=</span> layer_activation.shape[<span class="dv">1</span>]
    n_cols <span class="op">=</span> n_features <span class="op">/</span> images_per_row
    n_cols <span class="op">=</span> <span class="bu">int</span>(n_cols)
    display_grid <span class="op">=</span> np.zeros((size <span class="op">*</span> n_cols, images_per_row <span class="op">*</span> size))
    <span class="cf">for</span> col <span class="kw">in</span> <span class="bu">range</span>(n_cols):
        <span class="cf">for</span> row <span class="kw">in</span> <span class="bu">range</span>(images_per_row):
            channel_image <span class="op">=</span> layer_activation[<span class="dv">0</span>,:, :, col <span class="op">*</span> images_per_row <span class="op">+</span> row]
            channel_image <span class="op">-=</span> channel_image.mean()
            channel_image <span class="op">/=</span> channel_image.std()
            channel_image <span class="op">*=</span> <span class="dv">64</span>
            channel_image <span class="op">+=</span> <span class="dv">128</span>
            channel_image <span class="op">=</span> np.clip(channel_image, <span class="dv">0</span>, <span class="dv">255</span>).astype(<span class="st">&#39;uint8&#39;</span>)
            display_grid[col <span class="op">*</span> size : (col <span class="op">+</span> <span class="dv">1</span>) <span class="op">*</span> size,
                         row <span class="op">*</span> size : (row <span class="op">+</span> <span class="dv">1</span>) <span class="op">*</span> size] <span class="op">=</span> channel_image
    scale <span class="op">=</span> <span class="dv">1</span>. <span class="op">/</span> size
    plt.figure(figsize<span class="op">=</span>(scale <span class="op">*</span> display_grid.shape[<span class="dv">1</span>],
                        scale <span class="op">*</span> display_grid.shape[<span class="dv">0</span>]))
    plt.title(layer_name)
    plt.grid(<span class="va">False</span>)
    plt.imshow(display_grid, aspect<span class="op">=</span><span class="st">&#39;auto&#39;</span>, cmap<span class="op">=</span><span class="st">&#39;bone&#39;</span>)</code></pre></div>
<div class="figure">
<img src="output_13_0.png" alt="png" />
<p class="caption">png</p>
</div>
<div class="figure">
<img src="output_13_1.png" alt="png" />
<p class="caption">png</p>
</div>
<div class="figure">
<img src="output_13_2.png" alt="png" />
<p class="caption">png</p>
</div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="transfer-learning-with-cntk.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="neural-style-transfer.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/Azure/learnAnalytics-DeepLearning-Azure/edit/master/04-Fashion-MNIST-keras.Rmd",
"text": "Edit"
},
"download": ["azure-deep-learning.pdf", "azure-deep-learning.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(script.src))
      script.src  = script.src.replace(/^https?:/, '');
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
